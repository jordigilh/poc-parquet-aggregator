# Scenario 20: Cluster Alias Matching (Gap #1)
#
# PURPOSE: Test that AWS resources tagged with openshift_cluster matching cluster_alias
#          (not just cluster_id) are correctly attributed
#
# TRINO REFERENCE:
#   2_summarize_data_by_cluster.sql, line 639:
#   OR json_query(aws.tags, 'strict $.openshift_cluster' OMIT QUOTES) = ocp.cluster_alias
#
# SETUP:
#   - OCP cluster with cluster_id=test-cluster-001, cluster_alias=production
#   - AWS EC2 instances tagged with openshift_cluster=production (matches alias, not UUID)
#   - Expected: Costs should be attributed via cluster_alias match
#
# VALIDATES:
#   - Trino parity: cluster_alias matching (in addition to cluster_id)
#   - Tag matching uses BOTH cluster identifiers
#
# DATE: 2025-11-25
# STATUS: NEW - Tests Gap #1 from unbiased Trino analysis

start_date: "2025-10-01"
end_date: "2025-11-02"

# OCP Configuration
ocp:
  cluster_id: "test-cluster-001"
  cluster_alias: "production"  # Human-readable name

  generators:
    - generator: OCPGenerator
      attributes:
        start_date: "{{ start_date }}"
        end_date: "{{ end_date }}"
        nodes:
          - node: "{{ resource_id_1 }}"
            node_name: "prod-node-01"
            resource_id: "{{ resource_id_1 }}"
            cpu_cores: 4
            memory_gig: 16
            namespaces:
              app-prod:
                pods:
                  - pod: "frontend-prod"
                    cpu_request: 2
                    mem_request_gig: 4
                    labels: |
                      app: frontend
                      environment: production
                      tier: web

# AWS Configuration
aws:
  generators:
    - generator: EC2Generator
      attributes:
        start_date: "{{ start_date }}"
        end_date: "{{ end_date }}"

        resource_id: "{{ resource_id_1 }}"
        # KEY: Tag with cluster_alias, NOT cluster_id
        tags: |
          openshift_cluster: production
          environment: production

        amount: 1.0
        rate: 0.10
        # Expected daily cost: 24 hours * $0.10 = $2.40

# Expected Results
expected_output:
  summary:
    total_cost: 2.40
    namespaces: 1
    clusters: 1

  namespaces:
    app-prod:
      cost: 2.40
      # Full EC2 cost should be attributed via cluster_alias tag match

# Test Metadata
test_metadata:
  gap_id: "gap_01_cluster_alias"
  severity: "MEDIUM"
  trino_reference: "2_summarize_data_by_cluster.sql:639"
  description: "Validates cluster_alias tag matching in addition to cluster_id"

